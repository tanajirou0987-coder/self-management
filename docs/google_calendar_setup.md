# Google カレンダー連携ガイド

このアプリは **サービスアカウント** を使用して Google カレンダーと連携します。
以下の手順で設定してください。

## 1. Google Cloud プロジェクトの作成

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス。
2. 画面上部の「プロジェクトを選択」→「新しいプロジェクト」をクリック。
3. プロジェクト名（例: `self-management-app`）を入力し、「作成」をクリック。

## 2. Google Calendar API を有効化

1. 左メニューから **「APIとサービス」** > **「ライブラリ」** を選択。
2. 検索ボックスに **「Google Calendar API」** と入力し、表示された結果をクリック。
3. **「有効にする」** ボタンをクリック。

## 3. サービスアカウントの作成

1. 左メニュー **「APIとサービス」** > **「認証情報」** を選択。
2. 上部の **「+ 認証情報を作成」** > **「サービスアカウント」** をクリック。
3. サービスアカウント名（例: `calendar-sync`）を入力し、「完了」をクリック。
4. 作成されたサービスアカウントをクリックして詳細画面を開く。
5. 上部「キー」タブ > **「鍵を追加」** > **「新しい鍵を作成」** > タイプは **JSON** を選択。
6. JSONファイルがダウンロードされます。**このファイルは大切に保管してください。**

> [!IMPORTANT]
> ダウンロードしたJSONファイルは二度とダウンロードできません。紛失した場合は再度キーを作成する必要があります。

## 4. カレンダーへの共有設定

サービスアカウントがカレンダーにアクセスできるように、カレンダー側で共有設定を行います。

1. [Google カレンダー](https://calendar.google.com/) を開く。
2. 左サイドバーで連携したいカレンダーの **︙（三点メニュー）** > **「設定と共有」** をクリック。
3. **「特定のユーザーまたはグループと共有する」** セクションで **「+ ユーザーやグループを追加」** をクリック。
4. さきほど作成したサービスアカウントのメールアドレスを入力（例: `calendar-sync@your-project.iam.gserviceaccount.com`）。
5. 権限は **「予定の表示（すべての予定の詳細）」** を選択し、「送信」をクリック。
6. 同じ画面の **「カレンダーの統合」** セクションから **「カレンダー ID」** をコピーしておきます。

## 5. 環境変数の設定

ダウンロードした JSON ファイルを開き、以下の情報を `app/.env.local` に追記します。

```env
# Google Calendar 連携
GOOGLE_SERVICE_ACCOUNT_EMAIL=calendar-sync@your-project.iam.gserviceaccount.com
GOOGLE_SERVICE_ACCOUNT_KEY="-----BEGIN PRIVATE KEY-----\n...(JSONファイルの private_key の値)...\n-----END PRIVATE KEY-----\n"
GOOGLE_CALENDAR_ID=xxxxx@group.calendar.google.com
```

> [!NOTE]
> `GOOGLE_SERVICE_ACCOUNT_KEY` は JSON ファイル内の `private_key` の値をそのままコピペしてください。
> 改行は `\n` のままで問題ありません（コードが自動で変換します）。

## 6. 動作確認

1. 開発サーバーを再起動します。
   ```bash
   npm run dev
   ```
2. ブラウザで http://localhost:3000 を開きます。
3. ダッシュボードの「予定」カードにある **「同期」ボタン** をクリックします。
4. Google カレンダーに登録されている予定が表示されれば成功です！

## トラブルシューティング

- **「Google カレンダー連携の資格情報(GOOGLE_SERVICE_ACCOUNT_*)が設定されていません」**
  → `.env.local` が正しく設定されていないか、サーバーの再起動が必要です。

- **「Google カレンダー連携で問題が発生しました」**
  → サービスアカウントにカレンダーへのアクセス権限が付与されていない可能性があります。手順4を再確認してください。
